pipeline {
    agent any

    environment {
        // è¯­è¨€ç¯å¢ƒè®¾ç½® (ä½¿ç”¨ en_US.UTF-8)
        LANG = 'en_US.UTF-8'
        LC_ALL = 'en_US.UTF-8'

        // é¡¹ç›®é…ç½®
        PROJECT_NAME = 'pwtk-super-admin-web'

        // Node é…ç½®
        NODE_VERSION = 'v18.20.4'
        NODE_PATH = "/root/.nvm/versions/node/${NODE_VERSION}/bin"
        PNPM_PATH = "/root/.nvm/versions/node/v18.20.4/bin/pnpm"

        // æ—¥å¿—é…ç½®
        BUILD_LOG_FILE = "${WORKSPACE}/release_${BUILD_NUMBER}_${BUILD_TIMESTAMP}.log"

        // éƒ¨ç½²ç›®å½•ï¼ˆæ„å»ºå®ŒæˆååŒæ­¥åˆ°æ­¤ç›®å½•ï¼‰
        DEPLOY_DIR = '/home/www/websites/frontend/pwtk-super-admin-web'

        // å‘å¸ƒè®°å½•ç›®å½•ï¼ˆç”¨äºè®°å½•å·²å‘å¸ƒçš„ tagï¼‰
        RELEASE_RECORDS_DIR = '/home/www/jenkins-release-records/pwtk-super-admin-web'
    }

    options {
        // ä¿ç•™æœ€è¿‘ 10 æ¬¡æ„å»º
        buildDiscarder(logRotator(numToKeepStr: '10'))
        // ç¦æ­¢å¹¶å‘æ„å»º
        disableConcurrentBuilds()
        // æ„å»ºè¶…æ—¶æ—¶é—´
        timeout(time: 30, unit: 'MINUTES')
    }

    // æ‰‹åŠ¨è§¦å‘ï¼Œä¸è‡ªåŠ¨è½®è¯¢
    // triggers {
    //     pollSCM('H/5 * * * *')
    // }

    stages {
        stage('åˆå§‹åŒ–å’Œæ£€æŸ¥ Tag') {
            steps {
                script {
                    // åŠ è½½å·¥å…·å‡½æ•°åº“
                    sh '''
                        source ${WORKSPACE}/jenkins/lib/logger.sh
                        source ${WORKSPACE}/jenkins/lib/time-utils.sh
                        source ${WORKSPACE}/jenkins/lib/telegram.sh

                        # æ¸…ç†æ—§æ—¥å¿—
                        cleanup_old_logs "/tmp" "release_"

                        # åˆå§‹åŒ–æ—¥å¿—æ–‡ä»¶
                        init_log_file

                        log_message "=============== å‘å¸ƒæµç¨‹å¼€å§‹ ==============="
                        log_message "æ„å»ºç¼–å·: ${BUILD_NUMBER}"
                        log_message "å·¥ä½œç›®å½•: ${WORKSPACE}"

                        # è®°å½•æ„å»ºå¼€å§‹æ—¶é—´
                        BUILD_START_TIME=$(get_network_time)
                        BUILD_START_TIMESTAMP=$(get_timestamp "$BUILD_START_TIME")

                        echo "BUILD_START_TIME='${BUILD_START_TIME}'" > ${WORKSPACE}/release_vars.env
                        echo "BUILD_START_TIMESTAMP=${BUILD_START_TIMESTAMP}" >> ${WORKSPACE}/release_vars.env
                    '''

                    // æ£€æŸ¥å½“å‰æäº¤æ˜¯å¦æœ‰ tag
                    def currentTag = sh(
                        script: 'git describe --exact-match --tags HEAD 2>/dev/null || echo "no-tag"',
                        returnStdout: true
                    ).trim()

                    if (currentTag == 'no-tag') {
                        echo "âš ï¸ å½“å‰æäº¤æ²¡æœ‰ tagï¼Œæ— æ³•è¿›è¡Œå‘å¸ƒ"
                        echo "è¯·å…ˆåˆ›å»º tag: git tag -a v1.2.3 -m 'Release v1.2.3' && git push origin v1.2.3"
                        currentBuild.result = 'ABORTED'
                        error("å½“å‰æäº¤æ²¡æœ‰ tagï¼Œæ— æ³•è¿›è¡Œå‘å¸ƒ")
                    }

                    echo "âœ“ å½“å‰æäº¤çš„ tag: ${currentTag}"

                    // è®¾ç½®ç¯å¢ƒå˜é‡
                    env.RELEASE_TAG = currentTag

                    // æå–ç‰ˆæœ¬å·ï¼ˆç§»é™¤ 'v' å‰ç¼€ï¼‰
                    env.VERSION = currentTag.replaceFirst(/^v/, '')

                    echo "å°†å¤„ç† tag: ${currentTag}, ç‰ˆæœ¬: ${env.VERSION}"

                    // ç¡®ä¿å‘å¸ƒè®°å½•ç›®å½•å­˜åœ¨
                    sh """
                        source ${WORKSPACE}/jenkins/lib/logger.sh

                        mkdir -p ${RELEASE_RECORDS_DIR}
                        log_message \"å‘å¸ƒè®°å½•ç›®å½•: ${RELEASE_RECORDS_DIR}\"
                    """

                    // æ£€æŸ¥è¿™ä¸ª tag æ˜¯å¦å·²ç»å‘å¸ƒè¿‡ï¼ˆé€šè¿‡æ–‡ä»¶ç³»ç»Ÿï¼‰
                    def recordFile = "${RELEASE_RECORDS_DIR}/${currentTag}.release"
                    def tagAlreadyReleased = sh(
                        script: "test -f '${recordFile}' && echo 'true' || echo 'false'",
                        returnStdout: true
                    ).trim()

                    if (tagAlreadyReleased == 'true') {
                        // è¯»å–ä¹‹å‰çš„å‘å¸ƒä¿¡æ¯
                        def oldReleaseInfo = sh(
                            script: "cat '${recordFile}' 2>/dev/null || echo 'æœªçŸ¥'",
                            returnStdout: true
                        ).trim()

                        echo "âš ï¸ è­¦å‘Š: Tag ${currentTag} å·²ç»å‘å¸ƒè¿‡"
                        echo "ä¹‹å‰çš„å‘å¸ƒä¿¡æ¯:"
                        echo "${oldReleaseInfo}"
                        echo "----------------------------------------"
                        echo "å°†åˆ é™¤æ—§çš„å‘å¸ƒè®°å½•ï¼Œé‡æ–°å‘å¸ƒ..."

                        sh """
                            source ${WORKSPACE}/jenkins/lib/logger.sh
                            source ${WORKSPACE}/jenkins/lib/telegram.sh

                            log_message \"âš ï¸ Tag ${currentTag} é‡å¤å‘å¸ƒ\"
                            log_message \"åˆ é™¤æ—§çš„å‘å¸ƒè®°å½•: ${recordFile}\"
                            rm -f '${recordFile}'

                            # å‘é€æé†’é€šçŸ¥
                            send_telegram_message \"âš ï¸ é‡å¤å‘å¸ƒæé†’
é¡¹ç›®åç§°: ${PROJECT_NAME}
Tag: ${currentTag}
ç‰ˆæœ¬: ${env.VERSION}
æ“ä½œ: åˆ é™¤æ—§è®°å½•ï¼Œé‡æ–°å‘å¸ƒ\"
                        """
                    } else {
                        echo "âœ“ Tag ${currentTag} æ˜¯é¦–æ¬¡å‘å¸ƒ"
                    }

                    // ä¿å­˜åˆ°ç¯å¢ƒå˜é‡æ–‡ä»¶
                    sh """
                        echo "RELEASE_TAG=${env.RELEASE_TAG}" >> ${WORKSPACE}/release_vars.env
                        echo "VERSION=${env.VERSION}" >> ${WORKSPACE}/release_vars.env
                    """
                }
            }
        }

        stage('è·å–æäº¤ä¿¡æ¯') {
            when {
                expression { env.RELEASE_TAG != null }
            }
            steps {
                script {
                    sh '''
                        source ${WORKSPACE}/jenkins/lib/logger.sh
                        source ${WORKSPACE}/jenkins/lib/telegram.sh
                        source ${WORKSPACE}/release_vars.env

                        log_message "è·å–å½“å‰æäº¤ä¿¡æ¯ï¼ˆJenkins å·²æ£€å‡ºåˆ°æ­£ç¡®ä½ç½®ï¼‰"

                        # è·å–å½“å‰ HEAD çš„æäº¤ä¿¡æ¯ï¼ˆå…¼å®¹ Git 1.8ï¼‰
                        TAG_COMMIT_DATE=$(git log -1 --format='%ci' | sed 's/ [+-][0-9]\\{4\\}$//')
                        TAG_COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s")
                        TAG_COMMIT_HASH=$(git log -1 --pretty=format:"%H" | cut -c1-8)

                        echo "TAG_COMMIT_DATE='${TAG_COMMIT_DATE}'" >> ${WORKSPACE}/release_vars.env
                        echo "TAG_COMMIT_MESSAGE='${TAG_COMMIT_MESSAGE}'" >> ${WORKSPACE}/release_vars.env
                        echo "TAG_COMMIT_HASH='${TAG_COMMIT_HASH}'" >> ${WORKSPACE}/release_vars.env

                        log_message "Tag ä¿¡æ¯:"
                        log_message "  æäº¤æ—¥æœŸ: ${TAG_COMMIT_DATE}"
                        log_message "  æäº¤ä¿¡æ¯: ${TAG_COMMIT_MESSAGE}"
                        log_message "  æäº¤å“ˆå¸Œ: ${TAG_COMMIT_HASH}"

                        # å‘é€å‘å¸ƒå¼€å§‹é€šçŸ¥
                        send_telegram_message "ğŸš€ å¼€å§‹å‘å¸ƒ
æ—¶é—´: ${BUILD_START_TIME}
é¡¹ç›®åç§°: ${PROJECT_NAME}
Tag: ${RELEASE_TAG}
ç‰ˆæœ¬: ${VERSION}
æäº¤ä¿¡æ¯: ${TAG_COMMIT_MESSAGE}
æäº¤æ—¥æœŸ: ${TAG_COMMIT_DATE}"

                        update_progress 10 "ä»£ç æ£€å‡ºå®Œæˆ"
                    '''
                }
            }
        }

        stage('æå–ä¿®å¤ä¿¡æ¯') {
            when {
                expression { env.RELEASE_TAG != null }
            }
            steps {
                script {
                    sh '''
                        source ${WORKSPACE}/jenkins/lib/logger.sh
                        source ${WORKSPACE}/release_vars.env

                        log_message "æå–ä»ä¸Šä¸€ä¸ª tag åˆ°å½“å‰çš„ä¿®å¤ä¿¡æ¯"

                        # è·å–ä¸Šä¸€ä¸ª tag
                        PREV_TAG=$(git describe --tags --abbrev=0 ${RELEASE_TAG}^ 2>/dev/null || echo "")

                        if [ -z "${PREV_TAG}" ]; then
                            log_message "æ²¡æœ‰æ‰¾åˆ°ä¸Šä¸€ä¸ª tagï¼Œæå–æ‰€æœ‰æäº¤ä¸­çš„ä¿®å¤"
                            FIX_COMMITS=$(git log ${RELEASE_TAG} --oneline | grep -E "^[a-f0-9]+ fix[:(]" | head -20 || true)
                        else
                            log_message "ä¸Šä¸€ä¸ª tag: ${PREV_TAG}"
                            log_message "æå–ä» ${PREV_TAG} åˆ° ${RELEASE_TAG} çš„ä¿®å¤"
                            FIX_COMMITS=$(git log ${PREV_TAG}..${RELEASE_TAG} --oneline | grep -E "^[a-f0-9]+ fix[:(]" || true)
                        fi

                        if [ -z "${FIX_COMMITS}" ]; then
                            log_message "æ²¡æœ‰æ‰¾åˆ°åŒ…å« fix: çš„æäº¤"
                            echo "FIX_LIST='æ— ä¿®å¤è®°å½•'" >> ${WORKSPACE}/release_vars.env
                        else
                            log_message "æ‰¾åˆ°ä»¥ä¸‹ä¿®å¤:"
                            echo "$FIX_COMMITS" | while IFS= read -r line; do
                                log_message "  - $line"
                            done

                            # æ ¼å¼åŒ–ä¿®å¤åˆ—è¡¨ï¼Œæå– hash å’Œæ¶ˆæ¯
                            FIX_LIST=$(echo "$FIX_COMMITS" | awk '{
                                hash = $1
                                $1 = ""
                                msg = $0
                                gsub(/^[ \\t]+/, "", msg)
                                # æå– issue ç¼–å·ï¼ˆå¦‚æœæœ‰ï¼‰
                                if (match(msg, /#[0-9]+/)) {
                                    issue = substr(msg, RSTART, RLENGTH)
                                    printf "â€¢ %s %s\\\\n", issue, msg
                                } else {
                                    printf "â€¢ %s\\\\n", msg
                                }
                            }')

                            # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼ˆéœ€è¦è½¬ä¹‰å¼•å·ï¼‰
                            echo "FIX_LIST='${FIX_LIST}'" >> ${WORKSPACE}/release_vars.env
                            echo "PREV_TAG='${PREV_TAG}'" >> ${WORKSPACE}/release_vars.env
                        fi
                    '''
                }
            }
        }

        stage('æ£€æŸ¥ç‰ˆæœ¬æ–‡ä»¶') {
            when {
                expression { env.RELEASE_TAG != null }
            }
            steps {
                script {
                    sh '''
                        source ${WORKSPACE}/jenkins/lib/logger.sh
                        source ${WORKSPACE}/release_vars.env

                        log_message "æ£€æŸ¥å½“å‰ç‰ˆæœ¬æ–‡ä»¶"

                        # æ£€æŸ¥ package.json ç‰ˆæœ¬
                        CURRENT_PKG_VERSION=$(grep -m 1 '"version":' package.json | awk -F '"' '{print $4}')
                        log_message "å½“å‰ package.json ç‰ˆæœ¬: ${CURRENT_PKG_VERSION}"

                        # æ£€æŸ¥ webConfigApi.js ç‰ˆæœ¬
                        if [ -f "public/webConfigApi.js" ]; then
                            CURRENT_WEB_VERSION=$(grep "version:" public/webConfigApi.js | awk -F "'" '{print $2}')
                            log_message "å½“å‰ webConfigApi.js ç‰ˆæœ¬: ${CURRENT_WEB_VERSION}"
                        else
                            CURRENT_WEB_VERSION="none"
                            log_message "webConfigApi.js ä¸å­˜åœ¨"
                        fi

                        # ä¿å­˜å½“å‰ç‰ˆæœ¬
                        echo "CURRENT_PKG_VERSION=${CURRENT_PKG_VERSION}" >> ${WORKSPACE}/release_vars.env
                        echo "CURRENT_WEB_VERSION=${CURRENT_WEB_VERSION}" >> ${WORKSPACE}/release_vars.env

                        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
                        if [ "${CURRENT_PKG_VERSION}" = "${VERSION}" ] && [ "${CURRENT_WEB_VERSION}" = "${VERSION}" ]; then
                            echo "VERSION_NEEDS_UPDATE=false" >> ${WORKSPACE}/release_vars.env
                            log_message "ç‰ˆæœ¬æ–‡ä»¶å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ›´æ–°"
                        else
                            echo "VERSION_NEEDS_UPDATE=true" >> ${WORKSPACE}/release_vars.env
                            log_message "éœ€è¦æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶"
                        fi
                    '''

                    // è¯»å–æ˜¯å¦éœ€è¦æ›´æ–°
                    def versionNeedsUpdate = sh(
                        script: 'grep VERSION_NEEDS_UPDATE ${WORKSPACE}/release_vars.env | cut -d"=" -f2',
                        returnStdout: true
                    ).trim()

                    env.VERSION_NEEDS_UPDATE = versionNeedsUpdate
                }
            }
        }

        stage('æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶') {
            when {
                allOf {
                    expression { env.RELEASE_TAG != null }
                    expression { env.VERSION_NEEDS_UPDATE == 'true' }
                }
            }
            steps {
                script {
                    withCredentials([
                        usernamePassword(credentialsId: 'bf04844e-d069-43d6-9333-d20cd2caa5b9', usernameVariable: 'GIT_USERNAME', passwordVariable: 'GIT_PASSWORD')
                    ]) {
                        sh '''
                            source ${WORKSPACE}/jenkins/lib/logger.sh
                            source ${WORKSPACE}/jenkins/lib/telegram.sh
                            source ${WORKSPACE}/release_vars.env

                            log_message "æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶åˆ° ${VERSION}"

                            # æ›´æ–° package.json
                            log_message "æ›´æ–° package.json"
                            sed -i "s/\\"version\\": \\"[^\\"]* \\"/\\"version\\": \\"${VERSION}\\"/g" package.json

                            # éªŒè¯ package.json æ›´æ–°
                            NEW_PKG_VERSION=$(grep -m 1 '"version":' package.json | awk -F '"' '{print $4}')
                            if [ "${NEW_PKG_VERSION}" = "${VERSION}" ]; then
                                log_message "âœ“ package.json æ›´æ–°æˆåŠŸ: ${VERSION}"
                            else
                                log_message "âœ— package.json æ›´æ–°å¤±è´¥"
                                exit 1
                            fi

                            # æ›´æ–° webConfigApi.jsï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                            if [ -f "public/webConfigApi.js" ]; then
                                log_message "æ›´æ–° public/webConfigApi.js"
                                sed -i "s/version: '[^']*'/version: '${VERSION}'/g" public/webConfigApi.js

                                NEW_WEB_VERSION=$(grep "version:" public/webConfigApi.js | awk -F "'" '{print $2}')
                                if [ "${NEW_WEB_VERSION}" = "${VERSION}" ]; then
                                    log_message "âœ“ public/webConfigApi.js æ›´æ–°æˆåŠŸ: ${VERSION}"
                                else
                                    log_message "âœ— public/webConfigApi.js æ›´æ–°å¤±è´¥"
                                    exit 1
                                fi
                            fi

                            # æ›´æ–°æ ¹ç›®å½• webConfigApi.jsï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                            if [ -f "webConfigApi.js" ]; then
                                log_message "æ›´æ–° webConfigApi.js"
                                sed -i "s/version: '[^']*'/version: '${VERSION}'/g" webConfigApi.js
                            fi

                            # æ›´æ–° index.html æ—¶é—´æˆ³ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                            if [ -f "index.html" ]; then
                                log_message "æ›´æ–° index.html æ—¶é—´æˆ³"
                                NEW_TIMESTAMP=$(date "+%Y%m%d%H%M")

                                if grep -q '<script src="/webConfigApi.js?t=[0-9][0-9]*"></script>' index.html; then
                                    sed -i "s|<script src=\\"/webConfigApi.js?t=[0-9][0-9]*\\\"></script>|<script src=\\\"/webConfigApi.js?t=${NEW_TIMESTAMP}\\\"></script>|g" index.html
                                    log_message "âœ“ index.html æ—¶é—´æˆ³æ›´æ–°æˆåŠŸ: ${NEW_TIMESTAMP}"
                                else
                                    log_message "index.html ä¸­æœªæ‰¾åˆ°æ—¶é—´æˆ³æ¨¡å¼"
                                fi
                            fi

                            update_progress 30 "ç‰ˆæœ¬æ–‡ä»¶æ›´æ–°å®Œæˆ"

                            # æäº¤æ›´æ”¹
                            log_message "æäº¤ç‰ˆæœ¬æ›´æ–°"
                            git config user.name "Jenkins CI"
                            git config user.email "jenkins@ci.com"
                            git add package.json public/webConfigApi.js webConfigApi.js index.html 2>/dev/null || true
                            git commit -m "chore: bump version to ${VERSION} and update timestamp for release ${RELEASE_TAG}" || true

                            # ç§»åŠ¨ tag åˆ°æ–°æäº¤
                            log_message "ç§»åŠ¨ tag ${RELEASE_TAG} åˆ°å½“å‰æäº¤"
                            git tag -d ${RELEASE_TAG}
                            git tag -a ${RELEASE_TAG} -m "Release ${RELEASE_TAG} with version updates and timestamp"

                            # æ¨é€æ›´æ”¹ï¼ˆä½¿ç”¨ URL ç¼–ç å¯†ç ï¼‰
                            log_message "æ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“"
                            CURRENT_BRANCH=$(git branch --show-current)
                            if [ -z "${CURRENT_BRANCH}" ]; then
                                # å¦‚æœå¤„äº detached HEAD çŠ¶æ€ï¼Œåˆ‡æ¢åˆ° master æˆ– main
                                git checkout -b temp-release-branch
                                CURRENT_BRANCH="temp-release-branch"
                            fi

                            # URLç¼–ç å¯†ç ä¸­çš„ç‰¹æ®Šå­—ç¬¦
                            ENCODED_PASSWORD=$(printf '%s' "$GIT_PASSWORD" | jq -sRr @uri)

                            git remote set-url origin "https://${GIT_USERNAME}:${ENCODED_PASSWORD}@zr-svn8300.cccqx.com/pwtk/pwtk-super-admin-web.git"
                            git push origin ${CURRENT_BRANCH} || true
                            git push origin ${RELEASE_TAG} --force

                            log_message "ç‰ˆæœ¬æ–‡ä»¶æ›´æ–°å¹¶æ¨é€å®Œæˆ"
                            update_progress 40 "ç‰ˆæœ¬æ›´æ–°å·²æ¨é€"
                        '''
                    }
                }
            }
        }

        stage('å®‰è£…ä¾èµ–') {
            when {
                expression { env.RELEASE_TAG != null }
            }
            steps {
                script {
                    sh '''
                        source ${WORKSPACE}/jenkins/lib/logger.sh
                        source ${WORKSPACE}/jenkins/lib/telegram.sh
                        source ${WORKSPACE}/jenkins/lib/time-utils.sh

                        # æ·»åŠ  Node åˆ° PATH
                        export PATH="${NODE_PATH}:$PATH"

                        log_message "Node ç‰ˆæœ¬: $(node -v)"
                        log_message "pnpm ç‰ˆæœ¬: $(${PNPM_PATH} -v)"

                        log_message "æ¸…ç†æ—§çš„ node_modules"
                        rm -rf node_modules

                        log_message "å¼€å§‹å®‰è£…ä¾èµ–ï¼ˆä½¿ç”¨ pnpm installï¼‰"
                        INSTALL_START=$(date +%s)

                        # ä½¿ç”¨ pnpm installï¼ˆfrozen-lockfile ç¡®ä¿ä¸ pnpm-lock.yaml ä¸€è‡´ï¼‰
                        if [ -f pnpm-lock.yaml ]; then
                            log_message "ä½¿ç”¨ pnpm install --frozen-lockfile è¿›è¡Œå®‰è£…"
                            ${PNPM_PATH} install --frozen-lockfile 2>&1 | tee -a "$BUILD_LOG_FILE" || ${PNPM_PATH} install 2>&1 | tee -a "$BUILD_LOG_FILE"
                        else
                            log_message "pnpm-lock.yaml ä¸å­˜åœ¨ï¼Œä½¿ç”¨ pnpm install"
                            ${PNPM_PATH} install 2>&1 | tee -a "$BUILD_LOG_FILE"
                        fi

                        INSTALL_END=$(date +%s)
                        INSTALL_DURATION=$((INSTALL_END - INSTALL_START))
                        log_message "ä¾èµ–å®‰è£…å®Œæˆï¼Œè€—æ—¶: ${INSTALL_DURATION}ç§’"

                        update_progress 60 "ä¾èµ–å®‰è£…å®Œæˆ"
                    '''
                }
            }
        }

        stage('æ„å»ºç”Ÿäº§ç‰ˆæœ¬') {
            when {
                expression { env.RELEASE_TAG != null }
            }
            steps {
                script {
                    sh '''
                        source ${WORKSPACE}/jenkins/lib/logger.sh
                        source ${WORKSPACE}/jenkins/lib/telegram.sh
                        source ${WORKSPACE}/release_vars.env

                        # æ·»åŠ  Node åˆ° PATH
                        export PATH="${NODE_PATH}:$PATH"

                        log_message "å¼€å§‹æ„å»ºç”Ÿäº§ç‰ˆæœ¬"
                        ${PNPM_PATH} run build:dev 2>&1 | tee -a "$BUILD_LOG_FILE"

                        log_message "æ„å»ºå®Œæˆ"
                        update_progress 80 "æ„å»ºå®Œæˆ"
                    '''
                }
            }
        }

        stage('æ‰“åŒ…å‘å¸ƒäº§ç‰©') {
            when {
                expression { env.RELEASE_TAG != null }
            }
            steps {
                script {
                    sh '''
                        source ${WORKSPACE}/jenkins/lib/logger.sh
                        source ${WORKSPACE}/jenkins/lib/telegram.sh
                        source ${WORKSPACE}/release_vars.env

                        log_message "å¼€å§‹æ‰“åŒ…å‘å¸ƒäº§ç‰©"

                        # ç¡®å®šæ„å»ºç›®å½•
                        if [ -d "dist-dev" ]; then
                            BUILD_DIR="dist-dev"
                        elif [ -d "dist" ]; then
                            BUILD_DIR="dist"
                        elif [ -d "dist-prod" ]; then
                            BUILD_DIR="dist-prod"
                        elif [ -d "build" ]; then
                            BUILD_DIR="build"
                        else
                            log_message "é”™è¯¯: æœªæ‰¾åˆ°æ„å»ºäº§ç‰©ç›®å½•ï¼ˆæ£€æŸ¥è¿‡: dist-dev, dist, dist-prod, buildï¼‰"
                            exit 1
                        fi

                        log_message "ä½¿ç”¨æ„å»ºç›®å½•: ${BUILD_DIR}"

                        # åˆ›å»ºå‘å¸ƒåŒ…æ–‡ä»¶å
                        RELEASE_PACKAGE="${PROJECT_NAME}-${VERSION}.zip"
                        log_message "åˆ›å»ºå‘å¸ƒåŒ…: ${RELEASE_PACKAGE}"

                        # æ‰“åŒ…
                        cd ${BUILD_DIR}
                        zip -r ../${RELEASE_PACKAGE} . 2>&1 | tee -a "$BUILD_LOG_FILE"
                        cd ..

                        # éªŒè¯æ‰“åŒ…ç»“æœ
                        if [ -f "${RELEASE_PACKAGE}" ]; then
                            FILE_SIZE=$(du -h ${RELEASE_PACKAGE} | cut -f1)
                            log_message "âœ“ å‘å¸ƒåŒ…åˆ›å»ºæˆåŠŸ: ${RELEASE_PACKAGE} (${FILE_SIZE})"
                            echo "RELEASE_PACKAGE=${RELEASE_PACKAGE}" >> ${WORKSPACE}/release_vars.env
                            echo "PACKAGE_SIZE=${FILE_SIZE}" >> ${WORKSPACE}/release_vars.env
                        else
                            log_message "âœ— å‘å¸ƒåŒ…åˆ›å»ºå¤±è´¥"
                            exit 1
                        fi

                        update_progress 90 "æ‰“åŒ…å®Œæˆ"
                    '''
                }
            }
        }

        stage('å½’æ¡£äº§ç‰©') {
            when {
                expression { env.RELEASE_TAG != null }
            }
            steps {
                script {
                    // å½’æ¡£æ„å»ºäº§ç‰©
                    archiveArtifacts artifacts: '*.zip', allowEmptyArchive: false

                    sh '''
                        source ${WORKSPACE}/jenkins/lib/logger.sh

                        ZIP_FILES=$(ls *.zip 2>/dev/null || true)
                        if [ -n "${ZIP_FILES}" ]; then
                            log_message "å·²å½’æ¡£çš„å‘å¸ƒåŒ…:"
                            for file in ${ZIP_FILES}; do
                                log_message "  - ${file}"
                            done
                        fi
                    '''
                }
            }
        }
    }

    post {
        success {
            script {
                if (env.RELEASE_TAG) {
                    sh '''
                        source ${WORKSPACE}/jenkins/lib/logger.sh
                        source ${WORKSPACE}/jenkins/lib/telegram.sh
                        source ${WORKSPACE}/jenkins/lib/lark.sh
                        source ${WORKSPACE}/jenkins/lib/time-utils.sh
                        source ${WORKSPACE}/release_vars.env

                        # è®¡ç®—å‘å¸ƒè€—æ—¶
                        BUILD_END_TIME=$(get_network_time)
                        BUILD_END_TIMESTAMP=$(get_timestamp "$BUILD_END_TIME")
                        eval $(calculate_duration ${BUILD_START_TIMESTAMP} ${BUILD_END_TIMESTAMP})

                        log_message "=============== å‘å¸ƒå®Œæˆ ==============="
                        log_message "æ€»è€—æ—¶: ${MINUTES}åˆ†${SECONDS}ç§’"

                        # 100% - å®Œæˆ
                        update_progress 100 "å‘å¸ƒå®Œæˆ"

                        # è®°å½•å‘å¸ƒä¿¡æ¯åˆ°æ–‡ä»¶
                        RECORD_FILE="${RELEASE_RECORDS_DIR}/${RELEASE_TAG}.release"
                        log_message "åˆ›å»ºå‘å¸ƒè®°å½•: ${RECORD_FILE}"

                        cat > "${RECORD_FILE}" << EOF_RECORD
å‘å¸ƒæ—¶é—´: ${BUILD_END_TIME}
é¡¹ç›®åç§°: ${PROJECT_NAME}
Tag: ${RELEASE_TAG}
ç‰ˆæœ¬: ${VERSION}
æ„å»ºç¼–å·: ${BUILD_NUMBER}
å‘å¸ƒåŒ…: ${RELEASE_PACKAGE}
æ–‡ä»¶å¤§å°: ${PACKAGE_SIZE}
æäº¤ä¿¡æ¯: ${TAG_COMMIT_MESSAGE}
æäº¤æ—¥æœŸ: ${TAG_COMMIT_DATE}
æäº¤å“ˆå¸Œ: ${TAG_COMMIT_HASH}
è€—æ—¶: ${MINUTES}åˆ†${SECONDS}ç§’
EOF_RECORD

                        log_message "âœ“ å‘å¸ƒè®°å½•å·²ä¿å­˜"

                        # æ„å»ºä¿®å¤ä¿¡æ¯éƒ¨åˆ†
                        if [ "${FIX_LIST}" = "æ— ä¿®å¤è®°å½•" ]; then
                            FIX_SECTION=""
                            FIX_SECTION_MD=""
                        else
                            # è§£ç  FIX_LIST ä¸­çš„ \\n ä¸ºçœŸæ­£çš„æ¢è¡Œç¬¦
                            FORMATTED_FIXES=$(echo -e "${FIX_LIST}")
                            FIX_SECTION="

ğŸ“‹ æœ¬æ¬¡ä¿®å¤å†…å®¹:
${FORMATTED_FIXES}

ç‰ˆæœ¬èŒƒå›´: ${PREV_TAG:-é¦–æ¬¡å‘å¸ƒ} â†’ ${RELEASE_TAG}"

                            # Lark Markdown æ ¼å¼
                            FIX_SECTION_MD="

**ğŸ“‹ æœ¬æ¬¡ä¿®å¤å†…å®¹:**
${FORMATTED_FIXES}

**ç‰ˆæœ¬èŒƒå›´:** ${PREV_TAG:-é¦–æ¬¡å‘å¸ƒ} â†’ ${RELEASE_TAG}"
                        fi

                        # å‘é€ Telegram é€šçŸ¥
                        send_telegram_message "âœ… å‘å¸ƒæˆåŠŸ
æ—¶é—´: ${BUILD_END_TIME}
é¡¹ç›®åç§°: ${PROJECT_NAME}
Tag: ${RELEASE_TAG}
ç‰ˆæœ¬: ${VERSION}
å‘å¸ƒåŒ…: ${RELEASE_PACKAGE}
æ–‡ä»¶å¤§å°: ${PACKAGE_SIZE}
æäº¤ä¿¡æ¯: ${TAG_COMMIT_MESSAGE}
æäº¤æ—¥æœŸ: ${TAG_COMMIT_DATE}
commit hash: ${TAG_COMMIT_HASH}
è€—æ—¶: ${MINUTES}åˆ†${SECONDS}ç§’${FIX_SECTION}"

                        send_telegram_file "$BUILD_LOG_FILE" "âœ… å‘å¸ƒæˆåŠŸ - å®Œæ•´æ—¥å¿—"

                        # å‘é€ Lark é€šçŸ¥
                        DOWNLOAD_URL="http://jenkins-pw-admin.pwtk.cc:6061/view/pwtk/job/pwtk-super-admin-web-release/${BUILD_NUMBER}/artifact/${RELEASE_PACKAGE}"
                        LARK_CONTENT="**æ—¶é—´:** ${BUILD_END_TIME}
**é¡¹ç›®åç§°:** ${PROJECT_NAME}
**Tag:** ${RELEASE_TAG}
**ç‰ˆæœ¬:** ${VERSION}
**å‘å¸ƒåŒ…:** ${RELEASE_PACKAGE}
**æ–‡ä»¶å¤§å°:** ${PACKAGE_SIZE}
**ä¸‹è½½åœ°å€:** ${DOWNLOAD_URL}
**æäº¤ä¿¡æ¯:** ${TAG_COMMIT_MESSAGE}
**æäº¤æ—¥æœŸ:** ${TAG_COMMIT_DATE}
**commit hash:** ${TAG_COMMIT_HASH}
**è€—æ—¶:** ${MINUTES}åˆ†${SECONDS}ç§’${FIX_SECTION_MD}"

                        send_lark_message "âœ… å‘å¸ƒæˆåŠŸ" "${LARK_CONTENT}"

                        log_message "æ—¥å¿—æ–‡ä»¶ä¿å­˜åœ¨: $BUILD_LOG_FILE"
                    '''
                }
            }
        }

        failure {
            script {
                if (env.RELEASE_TAG) {
                    sh '''
                        source ${WORKSPACE}/jenkins/lib/logger.sh
                        source ${WORKSPACE}/jenkins/lib/telegram.sh
                        source ${WORKSPACE}/jenkins/lib/lark.sh
                        source ${WORKSPACE}/jenkins/lib/time-utils.sh
                        source ${WORKSPACE}/release_vars.env

                        # è®¡ç®—å¤±è´¥æ—¶é•¿
                        FAIL_TIME=$(get_network_time)
                        FAIL_TIMESTAMP=$(get_timestamp "$FAIL_TIME")
                        eval $(calculate_duration ${BUILD_START_TIMESTAMP} ${FAIL_TIMESTAMP})

                        log_message "å‘å¸ƒå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—"

                        # å‘é€ Telegram å¤±è´¥é€šçŸ¥
                        send_telegram_message "âŒ å‘å¸ƒå¤±è´¥
æ—¶é—´: ${FAIL_TIME}
é¡¹ç›®åç§°: ${PROJECT_NAME}
Tag: ${RELEASE_TAG}
ç‰ˆæœ¬: ${VERSION}
æäº¤ä¿¡æ¯: ${TAG_COMMIT_MESSAGE:-æœªçŸ¥}
æäº¤æ—¥æœŸ: ${TAG_COMMIT_DATE:-æœªçŸ¥}
é”™è¯¯: è¯·æŸ¥çœ‹ Jenkins æ—¥å¿—
è€—æ—¶: ${MINUTES}åˆ†${SECONDS}ç§’"

                        send_telegram_file "$BUILD_LOG_FILE" "âŒ å‘å¸ƒå¤±è´¥ - å®Œæ•´æ—¥å¿—"

                        # å‘é€ Lark å¤±è´¥é€šçŸ¥
                        LARK_FAIL_CONTENT="**æ—¶é—´:** ${FAIL_TIME}
**é¡¹ç›®åç§°:** ${PROJECT_NAME}
**Tag:** ${RELEASE_TAG}
**ç‰ˆæœ¬:** ${VERSION}
**æäº¤ä¿¡æ¯:** ${TAG_COMMIT_MESSAGE:-æœªçŸ¥}
**æäº¤æ—¥æœŸ:** ${TAG_COMMIT_DATE:-æœªçŸ¥}
**é”™è¯¯:** è¯·æŸ¥çœ‹ Jenkins æ—¥å¿—
**è€—æ—¶:** ${MINUTES}åˆ†${SECONDS}ç§’"

                        send_lark_message "âŒ å‘å¸ƒå¤±è´¥" "${LARK_FAIL_CONTENT}"
                    '''
                }
            }
        }

        always {
            script {
                // å½’æ¡£æ„å»ºæ—¥å¿—
                archiveArtifacts artifacts: 'release_*.log', allowEmptyArchive: true

                // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                sh '''
                    rm -f *.backup 2>/dev/null || true
                    echo "æ¸…ç†å®Œæˆ"
                '''
            }
        }
    }
}
