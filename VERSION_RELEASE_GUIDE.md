# 版本发布自动化指南

## 概述

本项目包含自动化脚本来管理版本发布流程，支持两种场景：

1. **本地交互式发布** - 通过菜单选择版本增量类型，自动计算版本号并执行发布
2. **Jenkins CI/CD 发布** - 从已存在的标签更新版本号并移动标签到新提交

## 文件说明

### 自动更新的文件

1. `package.json` - 项目版本号
2. `public/webConfigApi.js` - 前端配置中的版本号

### 脚本文件

1. `release.sh` - 交互式发布脚本（本地开发用）
2. `bash/jenkins-release.sh` - Jenkins CI/CD 发布脚本
3. `Jenkinsfile.release` - Jenkins Pipeline 配置文件

## 使用方法

### 方法一：本地交互式发布（推荐用于开发环境）

```bash
# 在项目根目录执行（必须在dev分支上）
./release.sh
```

脚本会启动交互式界面：

1. **自动获取当前版本号** - 从 `package.json` 读取当前版本
2. **显示版本选择菜单**：

   ```
   📦 Current version: 1.2.3

   Please select which version number to increment:

   1) Major version (1.2.3 → 2.0.0)
      Use for: Breaking changes, major new features

   2) Minor version (1.2.3 → 1.3.0)
      Use for: New features, backward-compatible changes

   3) Patch version (1.2.3 → 1.2.4)
      Use for: Bug fixes, small improvements

   Enter your choice (1-3):
   ```

3. **显示发布摘要并确认**：

   ```
   📋 Release Summary:
      Current version: 1.2.3
      New version:     1.3.0
      Tag to create:   v1.3.0

   Do you want to proceed with the release? (y/n):
   ```

4. **执行完整发布流程**

### 版本递增规则

- **主版本 (Major)**：适用于破坏性更改、重大新功能
  - `1.2.3` → `2.0.0` (次版本和修订版本重置为 0)
- **次版本 (Minor)**：适用于新功能、向后兼容的更改
  - `1.2.3` → `1.3.0` (修订版本重置为 0)
- **修订版本 (Patch)**：适用于错误修复、小改进
  - `1.2.3` → `1.2.4` (只递增修订版本)

### 安全检查流程

发布脚本会进行以下检查：

1. **检查当前分支** - 必须在 `dev` 分支上
2. **检查未提交更改** - 提醒用户处理未提交的更改
3. **拉取最新代码** - 自动 `git fetch` 和 `git pull`
4. **验证版本号** - 确保新版本号大于当前版本（自动保证）
5. **检查标签冲突** - 确保标签不存在
6. **创建标签并执行发布**

## 版本号格式

支持的版本号格式：

- `v1.2.3` (推荐)
- `v1.2.3-alpha.1`
- `v1.2.3-beta.2`
- `v1.2.3-rc.1`

## 安全功能

1. **验证检查**：脚本会验证版本号格式和更新结果

2. **错误退出**：任何步骤失败都会立即停止执行

## 示例流程

假设你要发布版本 `1.4.0`：

```bash
# 执行发布
./release.sh v1.4.0
```

执行后的变化：

- 创建 Git 标签 `v1.4.0`
- `package.json` 版本更新为 `"version": "1.4.0"`
- `public/webConfigApi.js` 版本更新为 `version: '1.4.0'`
- 执行构建脚本并生成发布包

## 注意事项

### 📋 本地发布前置条件

1. **必须在 `dev` 分支上** - 脚本会自动检查
2. **版本号必须递增** - 新版本号必须大于当前版本号
3. **建议提交所有更改** - 脚本会提醒未提交的更改
4. **确保网络连接** - 需要拉取最新代码和推送更改
5. **标签不能重复** - 脚本会检查标签是否已存在

### 🔒 安全检查

- ✅ **分支检查** - 只能在 `dev` 分支执行
- ✅ **代码同步检查** - 自动拉取最新代码
- ✅ **版本号递增检查** - 新版本必须大于当前版本
- ✅ **标签冲突检查** - 避免重复标签
- ✅ **操作确认** - 有未提交更改时询问用户
- ✅ **错误退出** - 任何检查失败都会立即停止

### 📊 版本号比较示例

假设当前版本是 `1.2.3`：

- ✅ **有效**: `v1.2.4`, `v1.3.0`, `v2.0.0`, `v1.2.3-alpha.1`
- ❌ **无效**: `v1.2.3`, `v1.2.2`, `v1.1.9`, `v0.9.9`

版本号比较规则：

- 主版本号 > 次版本号 > 补丁版本号
- 支持预发布版本（如 `-alpha.1`, `-beta.2`）
- 格式验证：必须符合 `major.minor.patch` 格式

### ⚠️ 其他注意事项

1. Jenkins 脚本会询问是否推送标签到远程仓库
2. 构建完成后会生成带时间戳的 zip 文件
3. 所有操作都有详细的日志输出

## Jenkins CI/CD 场景

### 远程发布流程（推荐用于生产环境）

当你在外面只能通过手机操作时：

#### 1. 通过手机创建标签

在 GitHub/GitLab 等平台上：

1. 进入项目仓库
2. 点击 "Releases" 或 "Tags"
3. 创建新标签，例如：`v1.2.3`

#### 2. Jenkins 自动检测并执行

Jenkins 会自动：

1. 检测到新标签 `v1.2.3`
2. 提取版本号 `1.2.3`
3. **同时更新版本和时间戳**：
   - 更新 `package.json` 版本号
   - 更新 `webConfigApi.js` 版本号
   - 更新 `index.html` 时间戳
4. **提交所有版本相关更改**
5. **将标签移动到版本更新提交上**
6. 推送更改和更新的标签到远程
7. **最后执行打包脚本** `package.sh`（纯打包，不修改文件）

#### 3. Jenkins 配置

```bash
# 1. 将 Jenkinsfile.release 配置到Jenkins项目中
# 2. 设置定时检查（每5分钟检查新标签）
# 3. 配置构建权限（需要能push到git仓库）
```

### 手动执行 Jenkins 脚本

如果需要手动执行：

```bash
# 处理最新标签
./bash/jenkins-release.sh

# 处理指定标签
./bash/jenkins-release.sh v1.2.3
```

### 关键特性

✅ **版本时间戳同步** - 版本号和时间戳在同一时刻更新 ✅ **纯净打包** - 打包脚本不修改任何源文件，仅生成产物 ✅ **幂等性** - 多次执行相同标签不会重复处理 ✅ **自动检测** - Jenkins 自动检测新标签 ✅ **完整日志** - 详细的执行过程和结果摘要

### 🎯 标签位置保证

最终 `v1.2.3` 标签将指向**版本更新提交**，包含：

- ✅ 版本号更新（package.json、webConfigApi.js）
- ✅ 构建时间戳更新（index.html）
- ❌ 不包含构建产物（.zip 文件单独生成）

### 📦 构建策略

- **版本先行** - 先更新版本信息再打包，确保一致性
- **分离关注点** - 版本管理和构建打包分离
- **文件不污染** - 打包过程不修改源代码文件
- **CI/CD 友好** - 清晰的步骤分离，便于调试和维护

## 故障排除

如果遇到问题，可以：

1. 删除错误的标签：`git tag -d v1.2.3`
2. 检查脚本执行权限：`chmod +x release.sh`
3. Jenkins 权限问题：确保 Jenkins 有 push 代码和标签的权限
4. 标签冲突：删除远程标签 `git push origin --delete v1.2.3`
